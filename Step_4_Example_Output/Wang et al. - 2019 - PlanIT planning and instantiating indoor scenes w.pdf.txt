References:

Annexes/Appendices:
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:5
left-right front-back rotational-2 rotational-4 corner-left corner-right radial
Fig.3. Possibletypesoffunctionalsymmetrieswithwhichgraphnodescanbelabeled,alongwithanexampleobjectofthatsymmetrytype.
front adjacent
left
adjacent
left right
distant supported proximal
back proximal
Fig.4. Relationshipsmodeledbytheedgesinourrelationgraphs.Wedefine
support edgesforstaticallysupportedchildnodes,andthefourspatial
edgesfront,left,right,andback,atthreedistances:adjacent,proximaland
distant.Thehueofeacharrowindicatestherelationshipdirection,andthe
saturationindicatesdistance.Supportednodesareoutlinedingreen.We
usethissamecolorschemethroughoutallfiguresinthispaper.
Functionalsymmetries: Eachobjectnoderequiresafunctional
symmetrytypelabel.Wemanuallylabelall3DmodelsintheSUNCG
Fig.5. Graphsbefore(left)andafter(right)thedetectionofsuperstructures.
Hub-and-spokeandchainsuperstructuresareindicatedwithyellowand
dataset,asthenumberofmodelsinthedatasetisnotprohibitively
brownboundingboxesaroundmembernodes,respectively.Superstructures
large(∼2600modelsacrossallcategories).
organizerelationshipsmorecompactly(e.g.thechainsofkitchencabinets
alongthewallsandthechairsrelativetothediningtable).
Supportedges: Foreachobject,weidentifypotentialsupporting
parentobjectsbytracingarayoutwardsfromthebottomofthe
object’sboundingboxuptoathresholddistanceof10cm.Ifthere
sothatgenerativemodelscanlearntocapturethem.Thesegroups
aremultiplepotentialsupportingobjects,weselecttheobjectthat
canbedetectedbysearchingfor“superstructure”patternsinthe
hasthelargestsupportingsurface.Webreaksupportedgecyclesby
extractedrelationgraph.
unparentingthelargestobjectinthecycle.
Wedetecttwotypesofsuchsuperstructuresinourgraphs:hub-
Spatialedges: Wecheckforeachpossibledirectionofaspatial and-spokesandchains.Ahub-and-spokesisdefinedbyalargerobject
edgeA→Bbyraycastingfromthefoursidesoftheorientedbound- surrounded by multiple instances of a smaller object (e.g. a bed
ingbox(OBB)ofA(projectedintotheXYplane).Foranintersected betweentwonightstands;atablesurroundedbychairs).Achain
objectBtocontributeanedgetothegraph,atleast30%oftheobject isdefinedbyaseriesofobjectsarrangedalongaline(e.g.arow
mustbevisiblefromA(determinedbytheintervaloverlapofB’s ofwardrobesagainstawall).Figure5showsanexampleofeach
OBBontoA’sOBB).Ifthisconditionissatisfiedformultipledirec- ofthesetypesofsuperstructures,andAppendixAdescribesour
tionsbetweenAandB,wepicktheonewiththehighestvisibility. heuristicsforextractingthemindetail.
Sinceradiallysymmetricobjectshavenomeaningfulorientation, Thereareotherhigh-levelstructureswecouldtrytodetectthat
allrelationshipsinwhichAisradially-symmetricaregiventhela- havebeenexploitedinothergraphicsdomains,e.g.gridsforin-
belfront.Distancelabelsaredeterminedbythedistancebetween verseproceduralmodelapplications[Bokelohetal.2010],butsuch
thetwoobjects’OBBs:adjacent ifAiswithintwoinchesofBor patternsdonotoccurfrequentlyinourdata.
within 5% of the largest diagonal of the two objects (whichever
Edgepruning: Thegraphsasextractedthusfararedense(average
issmaller),proximal ifAiswithin1.5feetor10%ofthelargest
of4edgespernodeacrossallroomsinourdataset),containingmany
diagonal(whicheverislarger),anddistantotherwise.
spatially-truebutnotsemantically-meaningfulrelationships.This
Detecting “superstructures”: Indoor scenes often contain func- densityposestwoproblemsforlearningagraphgenerativemodel.
tionalgroupsofobjects;ourgraphsshouldcontainthesestructures First,verydensegraphswillslowdowntraining.Second,andmore
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:6 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
Table1. Averagenodeandedgecountstatisticsforgraphsextractedfrom
thefirsttoapplydeepgenerativegraphmodelstoacomputergraph-
SUNCGroomsusingtheautomaticprocedurefromSection4.“Non-wall”
icsproblem.Thus,thegoalsofthissectionaretwofold.First,wein-
edgesarethosewhereneitherendpointisawall.
troducetheclassofgraphgenerativemodelweuse—autoregressive
generationbasedonmessage-passinggraphconvolution—tothe
RoomType #Nodes #Nodes(non-wall) #Edges #Edges(non-wall) graphicscommunity.Second,wedescribeaspecificimplementation
Bedroom 14.47 10.15 26.43 4.77 ofthistypeofgenerativemodelwithdomain-specificdesignchoices
Living 14.43 10.12 25.90 4.61 forindoorscenerelationshipgraphsynthesis.
Office 13.93 9.68 25.63 5.41
Bathroom 10.64 6.43 21.36 0.99 5.1 AutoregressiveGraphGenerationviaMessage-Passing
Kitchen 15.90 11.53 32.38 8.60 GraphConvolution
Ourapproachtographgenerationisbasedontheframeworkin-
troduced by [Li et al. 2018b]; for clarity, we highlight the core
componentsofthisapproachhere.Theideabehindautoregressive
graphgenerationistoconstructagraphviaasequenceofstructure-
buildingdecisions,whereeachdecisioniscomputedasafunctionof
thegraphthathasbeenbuiltthusfar.Specifically,onecanconstruct
agraphbyiteratingthefollowingsequenceofdecisions:
(1) Should a new node u be added to the graph? If no, then
terminate.Ifyes:
Fig.6. Examplesofrelationgraphsextractedfromtrainingsetscenes. (2) Shouldanewedgebeconnectedtou?Ifno,goto(1).Ifyes:
(3) Whichothernodevinthegraphshouldubeconnectedto?
Chooseone,thengoto(2).
critically,densegraphscanconfuseaneuralnetworkmodelby(1)
Onwhatbasisshouldthegeneratorshouldmakethesedecisions?
failingtorecognizethemostimportantstructuralrelationships(i.e.
Ideally,itwouldhavesomewayto“look”atthecurrentstateofthe
it“losesthesignalinthenoise”)or(2)predictingedgeswhichare
graphandmakeadecisionbasedonwhatit“sees.”Forimage-based
notself-consistent,i.e.itisimpossibletospatiallyrealizethegraph.
generativemodels,aconvolutionalneuralnetwork(CNN)provides
Thus,wepruneaway‘insignificant‘edgesfromtheextractedgraphs,
thiscapability:aCNNcaningestanimageandoutputadistribution
keepingonlythosethatreflectthemostmeaningfulrelationships.
overdecisions.Animagecanbeinterpretedasagraphwhosenodes
Wedothispruningheuristically:someedgesarealwayskeptor
arepixelsandwhoseedgesformaregular2Dlatticeoverthese
alwaysdeletedbasedonheuristicsaboutobjectfunctionality,and
pixels.Ifweinsteaduseirregularly-structuredgraphs,istherea
otheredgesmaybekeptiftheyoccurfrequentlyenoughacross
waytogeneralizeconvolution(andthusCNNs)tooperateonsuch
the whole dataset of rooms. Appendix A describes our pruning
data?Theformulationweuseismessagepassinggraphconvolution,
procedureindetail.
whichhasthefollowingsteps:
Guaranteeingconnectivity: Edgepruningmaymakethegraph
disconnected,i.e.thereexistsnodirectedpathfromthewallnodesto Initialization. Graphpropertiesarerepresentedeither
oneormoreobjectnodes.AswewilldescribeinSection6,ourscene asanodefeaturexu,describingthepropertiesofthe ! "
synthesisprocessiterativelyinsertsobjectswithaninboundedge node,oranedgefeaturexuv,describingrelationships
fromanobjectalreadyinthescene.Sincethisprocesscanstartwith betweentheendpointsoftheedge.Thegraphconvo- #init
onlywallsinthescene,asceneisnotsynthesizableifitsgraphis lutionprocessusesandupdatestheseproperties.For '
disconnected.Tosolvethisproblem,wefindallunreachablenodes brevity,weconsidertheversionthatonlyupdatesthe "
andreconnectthemtotherestofthegraphusingaminimum-cost- nodefeatures.Tofacilitatesuchupdate,itismostnaturaltousea
path-basedapproachdescribedinAppendixA. initializertomapthevisiblenodefeaturexuintoalatentrepresenta-
tionhu = finit(xu,...),takingthenodefeature,aswellasadditional
. Table1showssomestatisticsforourextractedgraphs.Figure6 featuressuchasadescriptionoftheentiregraph,asinputs.
showssomeexamplescenesandthegraphsextractedfromthem.
Propagation. Similarlytoimageconvolution,graphconvolution
5 GRAPHGENERATION aggregatesinformationfromproximalnodesinthegraph.Todoso,
Ourgoalisnowtolearnagenerativemodelfromourextracted thefollowingstepsareexecuted:
graphs. Graph generation is a long-studied problem [Erdos and 1.Computeedgemessages:Informationpropa-
Renyi1960;Rozenberg1997].Itiscurrentlyexperiencingarenais- gationinthegraphfollowsedges,whichdefine ! " ) "( ! (
sancedrivenbydeepneuralnetworkmodels.Highly-qualitygraph proximitiesinthegraph.Amessagefunctionfmsg
generativemodelshavethepotentialforhighimpactincomputer isusedtocomputedthepropagatedmessagemuv #msg
graphics,asmanyoftheobjectsgraphicsresearchersstudycanbe fromtheedgefeaturexuv andthelatentnodefea- '
naturallyrepresentedasgraphs:graphicdesignlayouts,urbanlay- tureshu,hv.Iftheedgeisdirected,theorderin "(
outs,curvenetworks,trianglemeshes,etc.Toourknowledge,weare whichinputsaresuppliedidentifiesthedirectionoftheedge.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:10 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
Input Scene Image
256
652
Edge Type
Embedding Matrix
Edge Type
Front, Adjacent
Location Distribution
ResNet-34
128 64 32 16 8 4
128
128
Fully Connected Layer
Conv
4x4 ~ 45 512 256 1
Upsample Conv
3x3
FiLM
Leaky
ReLU
Input Scene Image
+
10
CHAIR
Fig.9. Architectureofourgraph-conditionallocationpredictionnetwork.Weuseafully-convolutionnetwork(FCN)architecturetopredicta2Ddistribution
ofpossibleobjectlocations,intherelativecoordinateframeofananchorobject(orangeregionintheinputimage).Thenetwork’soutputisconditionedona
typeofrelationshipedgeviafeaturewiselinearmodulation(FiLM)[Perezetal.2018].Thenetworksimultaneouslypredictsdistributionsforallcategories;
herewevisualizetheslicefor“chair.”
Anchor1(Bottomwall) Anchor2(Rightwall) Combined FCNOutput CFCNOutput
Anchor1(Bed) Anchor2(Wall) Combined Fig.11. Outputofthepreviousunconditionalfullyconvolutionnetwork
(FCN)comparedwithouredge-conditionalCFCN.TheFCNpredictsmostly
Fig.10. Combiningmultipleanchor-relativelocationdistributionsintoone plausiblelocations,butisoblivioustothestructureofthegraphandthus
globaldistribution.Theanchorobjectishighlightedinpurple.Notehow likelytosuggestconstraint-violatinglocations.Onceagain,anchorobjects
theproductofthetwoanchor-relativedistributionsleavesanunambiguous (e.g.edgestartnodes)arhighlightedinpurpleintherighthandcolumn.
signalthatthebedshouldbeinthecorner(toprow)andthattheTVstand
shouldbedirectlyacrossfromthebed(bottomrow).
therelationshipsgivenbythegraph.Thisbecomesmorelikelyas
Orientationanddimensions. Toproposeorientationsandphysical
thenumberofgraphedges(andhencethenumberofconstraints)in
dimensionsforobjects,wealsoadopttheimage-basedmodulesfrom
thegraphincreases.Thus,weuseabacktrackingsearchprocedure
previouswork[Ritchieetal.2019].Theseareconditionalvariational
torollbackpreviously-instantiatedobjectswhenfacedwithacon-
autoencoders(CVAEs)whichtakeatop-downsceneimageasinput
straintthatcannotbesatisfied.AppendixBprovidesmoredetails
(centeredontheobjectinquestion)andoutputeitherafront-facing
onourbacktrackingpolicy.Aspartofthispolicy,wealsoallowthe
vector or 2D projected bounding box dimensions for the object.
searchprocesstobeginviolatingconstraintsasitaccumulatesa
Onecouldimaginemodifyingthesenetworkstomakethemgraph-
largenumberofbacktrackingsteps.Thisissometimesnecessary
aware,inasimilarmannertothelocationmoduledescribedabove.
toinstantiateagraphatall,asourgraphgenerativemodeldoes
However,wefoundthisextracomplexitynottobenecessary,as
not(andingeneralcannot)guaranteethatthegraphsitoutputs
theobject’slocationandspatialcontexttendtoprovidesufficient
arephysicallyrealizable.AppendixBalsodescribesourpolicyfor
conditioninginformationtomakereasonablechoices.
thisformofconstraintrelaxation,whichquantifiestheextentto
Backtracking: Evenwiththeneurally-guidedlocationsampling whichanobjectisinviolationofitsconstraintsandallowsthis
proceduresdescribedabove,instantiatingobjectsintheorderpre- valuetograduallyincreaseasafunctionofthenumberoftimes
scribedbySection6.1canstillleadtosceneswhichdonotsatisfyall thatattemptingtoinstantiatetheobjecthasledtobacktracking.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.

Body Text:
PlanIT: Planning and Instantiating Indoor Scenes with Relation Graph
and Spatial Prior Networks
KAIWANG,BrownUniversity
YU-ANLIN,BrownUniversity
BENWEISSMANN,BrownUniversity
MANOLISSAVVA,SimonFraserUniversity
ANGELX.CHANG,SimonFraserUniversity
DANIELRITCHIE,BrownUniversity
Fig.1. WepresentPlanIT:ascenesynthesisframeworkthatunifieshigh-levelplanningofscenestructureusingagenerativemodeloverrelationgraphswith
lower-levelspatialinstantiationusingneural-guidedsearchwithspatialneuralnetworkmodules.Wefirstgeneratearelationgraphwithobjectsatthenodes
andspatialorsemanticrelationsattheedges(leftimages).Then,giventhegraphstructureweselectandplaceobjectstoinstantiateaconcrete3Dscene.
Wepresentanewframeworkforinteriorscenesynthesisthatcombinesa representation.Thesegraphsallowthesystemtosupportapplicationssuch
high-levelrelationgraphrepresentationwithspatialpriorneuralnetworks. asscenesynthesisfromapartialgraphprovidedbyauser.
Weobservethatpriorworkonscenesynthesisisdividedintotwocamps:
CCSConcepts:•Computingmethodologies→Computergraphics;
object-orientedapproaches(whichreasonaboutthesetofobjectsinascene
Neuralnetworks;Probabilisticreasoning;
andtheirconfigurations)andspace-orientedapproaches(whichreason
aboutwhatobjectsoccupywhatregionsofspace).Ourinsightisthatthe
AdditionalKeyWordsandPhrases:indoorscenesynthesis,objectlayout,
object-orientedparadigmexcelsathigh-levelplanningofhowaroomshould
neuralnetworks,convolutionalnetworks,deeplearning,relationshipgraphs,
belaidout,whilethespace-orientedparadigmperformswellatinstantiating
graphgeneration
alayoutbyplacingobjectsinprecisespatialconfigurations.Withthisin
mind,wepresentPlanIT,alayout-generationframeworkthatdividesthe ACMReferenceFormat:
problemintotwodistinctplanningandinstantiationphases.PlanITrepre- KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,
sentsthe“plan”forasceneviaarelationgraph,encodingobjectsasnodes andDanielRitchie.2019.PlanIT:PlanningandInstantiatingIndoorScenes
andspatial/semanticrelationshipsbetweenobjectsasedges.Intheplanning withRelationGraphandSpatialPriorNetworks.ACMTrans.Graph.38,4,
phase,itusesadeepgraphconvolutionalgenerativemodeltosynthesize Article132(July2019),15pages.https://doi.org/10.1145/3306346.3322941
relationgraphs.Intheinstantiationphase,itusesimage-basedconvolutional
networkmodulestoguideasearchprocedurethatplacesobjectsintothe 1 INTRODUCTION
sceneinamannerconsistentwiththegraph.Bydecomposingtheproblemin
thisway,PlanITgeneratesscenesofcomparablequalitytothosegenerated Peoplespendalargepercentageoftheirlivesindoors—inbedrooms,
bypriorapproaches(asjudgedbybothpeopleandlearnedclassifiers),while livingrooms,kitchens,etc.Ascomputergraphicsreproducesthereal
alsoprovidingthemodelingflexibilityoftheintermediaterelationshipgraph worldinincreasingfidelity,thedemandforvirtualversionsofsuch
spacesalsogrows.Virtualandaugmentedrealityexperiencesoften
Authors’addresses:KaiWang,BrownUniversity;Yu-anLin,BrownUniversity;Ben takeplaceinsuchenvironments.Onlinevirtualinteriordesigntools
Weissmann,BrownUniversity;ManolisSavva,SimonFraserUniversity;AngelX.
areavailabletohelppeopleredesigntheirownspaces[Planner5d
Chang,SimonFraserUniversity;DanielRitchie,BrownUniversity.
2017;RoomSketcher2017].Somefurnituredesigncompaniesnow
©2019AssociationforComputingMachinery. primarilyadvertisetheirproductsbyrenderingvirtualscenes,asit
Thisistheauthor’sversionofthework.Itispostedhereforyourpersonaluse.Notfor isfaster,cheaper,andmoreflexibletodosothantostagereal-world
redistribution.ThedefinitiveVersionofRecordwaspublishedinACMTransactionson
scenes[ChaosGroup2018].Finally,machinelearningresearchers
Graphics,https://doi.org/10.1145/3306346.3322941.
havebegunturningtovirtualenvironmentstotraindata-hungry
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:2 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
modelsforcomputervisionandroboticnavigation[Daietal.2018; Whilewefocusonthedomainofindoorscenesynthesisinthis
Dasetal.2018;Gordonetal.2018;Lange2018]. paper,webelievethatPlanIT’s“plan-and-instantiate”framework
Giventhisinterestinvirtualindoorscenesandthelargeamount hasbroaderapplicabilitytootherlayout-generationproblemsin
ofeffortrequiredtoauthorthemwithtraditionaltools,agenerative computergraphics.
modelofsuchsceneswouldbevaluable.Indeed,manyresearchers Oursystemstartswithalargesetofunstructured3Dscenesand
havestudiedthisproblemofindoorscenesynthesisoverthepast automaticallyextractsrelationshipgraphsusinggeometricandsta-
decade.Twomajorfamiliesofapproacheshaveemergedinthisline tisticalheuristics.Toinstantiatethesegraphsintoconcretescenes,
ofwork.Thefirstfamilyofmodelsisobject-oriented:theyexplicitly weuseaneurally-guidedsearchprocedurebuildinguponconvolu-
representthesetofobjectsinthesceneandtheirproperties[Fisher tionalneuralnetwork(CNN)-basedscenesynthesismodulesfrom
etal.2012;Lietal.2018a;Qietal.2018;Zhangetal.2018].The recentwork[Ritchieetal.2019].Tolearnhowtogeneratethegraphs
secondfamilyofmodelsisspace-oriented:theyinsteadtreatspaceas themselves,weagainleverageconvolutionasanoperatorforcap-
afirst-classentity,modelingwhatoccupieseachpointinspace.Here, turingcontext.However,insteadofspatialcontext(intheformof
spacetypicallytakestheformofaregulargrid,asinrecentimage- imageneighborhoods),wecapturesymbolicrelationalcontextvia
basedscenesynthesismodels[Ritchieetal.2019;Wangetal.2018]. graphconvolutionalnetworks(GCN).WeuseaGCN-basedgenera-
This modeling dichotomy is analogous to the division between tivemodelofscenerelationshipgraphswhichbuildsonrecentwork
LagrangianandEuleriansimulationmethods. ondeepgenerativemodelsofgraphs[Lietal.2018b].Ourpipeline
Eachapproachhasstrengthsandweaknesses.Theobject-oriented canbeusedtosynthesizenewscenesfromscratch,tocompletepar-
paradigm facilitates explicit reasoning about objects as discrete tialscenes,ortosynthesizescenesfromacompleteorpartialgraph
entities,supportingsymbolicqueriessuchas“generateascenewith specification.Thelatterparadigmhasapplicationsbothforrapid,
achairandtwotables.”Thisrepresentationalsofacilitatesdetecting accessiblescenedesignaswellasforgeneratingcustom-tailored
andexploitinghigh-levelarrangementpatterns,suchassymmetries. trainingenvironmentsforvision-basedautonomousagents.
However,becauseobject-orientedapproachesabstractawaylow- Ourunifiedscenesynthesispipelinegeneratesscenesthatare
levelspatialdetails(suchastheprecisegeometryoftheobjects judged(bybothlearnedclassifiersandpeople)tobeofcomparable
andthearchitectureofrooms),theycanstrugglewithfine-grained qualitytoscenesgeneratedbypriormethodsthatareeitherspace-
arrangement.Space-orientedsystems,bycontrast,excelatcomplex orientedorobject-oriented.Wealsodemonstratethatourpipeline
low-levelspatialreasoning(supportingarbitrarilyshapedrooms enablesapplicationssuchasgenerating3Dscenesfrompartially
andirregularobjectgeometry)butoftenmisshigh-levelpatterns specifiedscenegraphs,andgeneratingcustom3Dscenesfortraining
anddonotsupportsymbolicqueries. roboticsandvisionsystems.
Inthispaper,weproposePlanIT,anewconceptualframework Insummary,ourcontributionsare:
for layout generation that unites the object-oriented and space-
(1) Anovel“plan-and-instantiate”conceptualframeworkforlay-
orientedparadigmstoachievethebestofbothworlds.Specifically,
outgenerationproblems,andaconcreteimplementationof
PlanITplansthestructureofascenebygeneratingarelationship
thisframeworkforthedomainofindoorscenesynthesis.
graph,andthenitinstantiatesaconcrete3Dscenewhichconforms
(2) Aformulationofrelationshipgraphsforindoorscenelayouts
tothatplan.Relationshipgraphshelpoursystemreasonsymboli-
andaheuristicprocedureforextractingthemfromunstruc-
callyaboutobjectsandtheirhigh-levelpatterns. Inarelationship
tured3Dscenes.
graph,eachnoderepresentsanobject,andeachdirectededgerep-
(3) Anintroductiontodeepgenerativegraphmodelsbasedon
resentsaspatialorfunctionalrelationshipbetweentwoobjects.We
message-passing graph convolution, and a specific model
learnagenerativemodelofsuchgraphswhichcanbesampledto
architectureforgeneratingindoorscenerelationshipgraphs.
synthesizenewhigh-levelscenelayouts.Then,givenagraph,we
(4) Aneurally-guidedsearchprocedureforinstantiatingscenere-
useasetofimage-based(i.e.space-oriented)modelstoinstantiate
lationshipgraphs,usingimage-basedscenesynthesismodels
thehigh-levelrelationshipgraphintoalow-levelcollectionofar-
augmentedwithanawarenessoftheinputgraph.
ranged3Dobjects.Eachpartofthesystemfocusesonthedomain
atwhichitexcels:thegraph-basedmodulereasonsaboutwhich Sourcecodeandpretrainedmodelsforoursystemcanbefoundat
objectsshouldbeinthesceneandtheirhigh-levelarrangement https://github.com/brownvc/planit.
patterns,whiletheimage-basedmodulesdeterminespreciseplace-
2 BACKGROUND&RELATEDWORK
ments,orientations,andobjectsizes.Thispipelinecanbeviewedas
anabstractionhierarchy:wefirstsynthesizeanabstractscene(i.e. Wediscussrelatedworkinscenesynthesis,scenegraphrepresenta-
agraph),andthenwesynthesizeaconcretesceneconditionedon tionsforrelatedproblems,andgraphgenerativemodels.
theabstractrepresentation.Webelievethatthismulti-resolution
modelingapproachisabettermatchtothenatureofrealscenes IndoorSceneSynthesis: Thereisalonglineofworkaddressing3D
(high-levelstructuralvariationinarrangements,andlow-levelde- scenesynthesis.Earlyworkusedarule-basedconstraintsatisfaction
tailsinobjects)andalsomirrorsthehumanthoughtprocesswhen formulationtogenerate3Dobjectlayoutsforpre-specifiedsetsof
designingandlayingoutspaces(startingfromoverallobjectlayouts objects[Xuetal.2002].Otherapproacheswerebasedonoptimiza-
inaroom,andthenplacingindividualobjects).Moreover,thegraph tionofcostfunctionsderivedfrominteriordesignprinciples[Mer-
isausefulintermediaterepresentationformanyapplicationsthat relletal.2011]andobject–objectstatisticalrelationships[Yuetal.
involvecomposition,editing,andmanipulationofscenestructure. 2011].Theearliestdata-drivenworkmodeledobjectco-occurrences
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:3
usingaBayesiannetwork,andGaussianmixturesforpairwisespa- 2018b]. Otherrecentworkproposesarecurrentarchitecturefor
tialrelationstatisticsextractedfrom3Dscenes[Fisheretal.2012]. graphs,targetedatapplicationsinvolvinglargenetworkgraphs[You
Followup work has used undirected factor graphs learned from etal.2018b].Ouroverallscenesynthesisapproachisbasedoncom-
annotatedRGB-Dimages[Kermanietal.2016],relationgraphsbe- biningaGCN-basedgenerativemodelover3Dscenerelationship
tweenobjectslearnedfromhumanactivityannotations[Fuetal. graphswithimage–basedCNNmodules.Toourknowledge,we
2017],anddirectedgraphicalmodelswithGaussianmixturesfor arethefirsttoapplyadeepgenerativegraphmodelincomputer
modelingarrangementpatterns[PaulHenderson2018].Otherwork graphicsingeneralandto3Dscenesynthesisinparticular.
hasfocusedonconditioningthescenegenerationusinginputfrom
RGB-Dframes[Chenetal.2014],2Dsketchesofthescene[Xuetal.
2013],naturallanguagetext[Changetal.2015;Maetal.2018b],or 3 OVERVIEW
activitypredictionsonRGB-Dreconstructions[Fisheretal.2015].
Inthispaper,wetacklethescenesynthesisproblem:giventhear-
Morerecently,withtheavailabilityoflargedatasetsof3Denviron-
chitecturalspecificationofaroom(walls,floor,andceiling)ofa
mentssuchasSUNCG[Songetal.2017],learning-basedapproaches
particulartype(e.g.bedroom),chooseandarrangeasetofobjects
havebecomepopular.Avarietyofapproacheshavebeenproposed
tocreateaplausibleinstanceofthattypeofroom.Indoingso,we
using:human-centricprobabilisticgrammars[Qietal.2018],Gen-
aimtobuildasystemthatcansupportarangeofusecases.Inad-
erativeAdversarialNetworkstrainedonamatrixrepresentation
ditiontosynthesizingascenefromanemptyroom,itshouldalso
ofpresentsceneobjects[Zhangetal.2018],recursiveneuralnet-
completepartialscenes.Furthermore,itshouldacceptahigh-level
workstrainedtosample3Dscenehierarchies[Lietal.2018a],and
specificationforwhatshouldbeintheroomintheformofapartial
convolutionalneuralnetworks(CNNs)trainedontop-downimage
orcompleterelationgraph.Forexample,oursystemshouldsupport
representationsofrooms[Ritchieetal.2019;Wangetal.2018].Our
thequery“givemeabedroomwithadeskandatelevision,where
systemusesthefastCNNmodulesofthelatterimage-basedmethod
thedeskistotheleftofthebed.”Ourapproachtotheproblemis
toinstantiaterelationshipgraphs,modifiedsignificantlytowork
todecomposeitintotwosteps.First,oursystemgeneratesare-
witharelationshipgraphasinput.
lationgraph.Thisgraphencodesmajorsalientrelationshipsthat
SceneGraphRepresentations: Representingscenesasgraphsof characterizeascenelayoutbutdoesnotcompletelyspecifyascene.
semanticrelationships(encodedasedges)betweenobjects(encoded However,itdoesprovideastrongsignalfromwhichtogenerate
asnodes)isanelegantmethodologywithapplicationstoavariety oneormoreinstantiationsofthegraph.
ofdomains.Ithasbeenusedfortext-to-scenegeneration[Chang Westartbyautomaticallyextractingrelationgraphsfromun-
etal.2014].Otherworkingraphicshasusedasmalldatasetofman- structured3Dscenes,usinggeometricrulesandthestatisticsof
uallyannotatedscenehierarchiestolearnagrammarforpredicting alargedatabaseofscenestodecidewhatrelationshipsexistand
hierarchicaldecompositionsofinput3Dscenes[Liuetal.2014].In whichonesaremostsalient(Figure2Left).Section4describesthis
computervision,semanticscenegraphswerepopularizedbythe process,aswellasourgraphrepresentation,inmoredetail.
VisualGenomeprojectwhichcollectedalargedatasetofimage Next,weusethiscorpusofextractedgraphstolearnagenerative
scenegraphannotations[Krishnaetal.2017].Subsequentworkhas modelofgraphs(Figure2Middle).Ourgenerativemodeltakesan
focusedongeneratingscenegraphsfromimages[Lietal.2017;Lu inputgraphthatiseitherempty(i.e.containingonlynodesandedges
etal.2016;Xuetal.2017;Yangetal.2018;Zellersetal.2018],using representingroomarchitecturefeaturessuchaswalls)orpartially
scenegraphsforimageretrieval[Johnsonetal.2015],generating occupiedwithobjects,andgeneratesadditionalnodesandedgesto
2Dimagesgivenaninputscenegraph[Johnsonetal.2018],and completethegraph.Ourmodelisadeepgenerativemodelthatuses
improvingtheevaluationofimagecaptioning[Andersonetal.2016]. aformofdiscreteconvolutionongraphsasitsprimaryoperator.It
Thisdiversityofapplicationsisenabledbythegeneralityofthe isbasedonanarchitecturewhichwasappliedtogeneratesimple
scenegraphrepresentation,andisoneofourmainmotivationsfor graphsinotherdomains,e.g.moleculestructures[Lietal.2018b].
incorporatingagraphrepresentationinourapproach.Incontrastto Section5describesthismodelinmoredetail.
priorwork,wefocusondemonstratingthatourunifiedformulation Withacompletegraphinhand,thefinalstepinourpipelineis
thatcombinesarelationgraphgenerativemodelwithimage-based toinstantiatetheabstractgraphintoaconcretescenebychoosing
neuralnetworksenablesustoimprove3Dscenesynthesis. andplacing3Dmodelswhichrespecttheobjectsandrelationships
impliedbythegraph(Figure2Right).Therearemanypossiblemeth-
GraphGenerativeModels: Recently,thereisanexcitinglineof
odsonecouldusetosearchforconcretescenelayoutsconsistent
work on defining graph–structured neural networks and using
witharelationgraph.Sincethescenelayoutprocessinvolveslow-
themtolearnagenerativemodelsofgraphs.Someoftheearliest
levelspatialreasoning,weopttouseimage-basedneuralnetwork
workingraphprocessingwithneuralnetworksproposedagraph
modulestoguideoursearch.Usingneuralnetworksprovidesro-
convolutionalneuralnetwork(GCN)toperformgraphclassifica-
bustnesstothenoisepresentinrelationgraphsbothinthetraining
tion[KipfandWelling2016].OtherworkhasusedaGCNapproach
dataandfortheoutputgraphsofourgenerativemodel.Weadapt
forskeleton-basedactionrecognition[Yanetal.2018]. Ourgraph
modulesfromrecentworkonscenesynthesis[Ritchieetal.2019],
generativemodelusesaformulationofGCNsbasedonmessage
modifyingthemtotakethegraphasinputandtoattempttoadhere
passingbetweennodesinagraph[Gilmeretal.2017].Itspecifically
tothestructurethatitmandates.Section6describesthesemodules,
builds on a recently-developed autoregressive generative model
andouroverallsceneinstantiationsearchprocedure,inmoredetail.
forarbitrarygraphsusingthemessage-passingapproach[Lietal.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:4 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
Extract Relationship Graphs (Section 4) Graph Generation (Section 5) Scene Instantiation (Section 6)
Scenes Graphs
Empty or Partial Graph Complete Room Graph
Partial Scene Image Representation Scene w/ New Object
Location?
Orient?
Size?
Model?
Iterate
Training Data for Graph Generation and Scene Instantiation Modules
Fig.2. Ourscenesynthesispipeline.Weautomaticallyextractrelationgraphsfromscenes(Section4),whichweusetotrainadeepgenerativemodelofsuch
graphs(Section5).Inthisfigure,thegraphnodesarelabeledwithaniconindicatingtheirobjectcategory.Wethenuseimage-basedreasoningtoinstantiatea
graphintoaconcretescenebyiterativeinsertionof3Dmodelsforeachnode(Section6).
4 TURNINGSCENESINTORELATIONGRAPHS
somewayduetophysicallawsorfunctionaluse.Forphysicalplau-
Inthissection,wemotivateanddefineourrelationgraphrepresen-
sibility,ourgraphsincludesupportedges:edgeA→Bimpliesthat
tation,andwedescribeaprocedureforautomaticallyextracting objectBisphysicallysupportedbyobjectA(e.g.alampsupported
thesegraphsfromunstructured3Dscenes. byatable).Tocapturearrangementpatternsthatreflectfunctional
use,graphsalsoincludespatialedges:A→BimpliesthatobjectB
4.1 Dataset isplacedatsomedistanceawayfromobjectA,insomedirection
relativetoobjectA(e.g.anottomaninfrontofachair).Wefurther
Forallofourexperiments,weusetheSUNCGdataset,acollection
subdividespatialedgesintomultiplesubtypes,definedastheCarte-
ofoverfortythousandscenesdesignedbyusersofanonlineinterior
sianproductoffourdirectiontypes(front,back,right,left)and
designtool[Songetal.2017].Fromthisrawscenecollection,we
threedistancetypes(adjacent,proximal,distant)foratotalof
extractroomsoffivecommontypes:bedrooms,livingrooms,bath-
12spatialedgetypes.Directionsaredefinedinthelocalcoordinate
rooms,andoffices.Wealsoperformpre-processingontheserooms
frameoftheedgestartnode.Weusediscretedistancetypesbecause
tofilteroutmislabeledrooms,removeuncommonobjects,etc.,us-
peopleusesuchtermswhendescribingspatialrelationships,sug-
ingaprocedurebasedononefrompriorwork[Ritchieetal.2019].
gestingthattheremaybesalientcategoricaldifferencesbetween
Ourfilteringprocedureadditionallyremovesroomsthatarenot
differentdistancelevels.Figure4showssomeexamplesofdifferent
closed(i.e.arenotencircledbyaclosedloopofwalls),asourgraph
relationshiptypes.
representationrequiresthistobethecase(Section4.2).Thisresults
in5900bedrooms(with41uniqueobjectcategories),1100living Representingtheroomarchitecture: Thearchitecturalgeometry
rooms(37categories),6400bathrooms(26categories),1000offices oftheroominfluencesthelayoutofobjectswithinitandthusmust
(37categories),and1900kitchens(39categories).Theseroomsare alsobemodeledintherelationgraph.Werepresentthisgeometry
representedasaflatlistofobjects(withcategorylabel,geometry, withadditionalnodes,oneforeachlinearwallsegment,connected
andtransformation);theycontainnoinformationaboutstructural, byabi-directionalloopofadjacentedges(abi-directionaledgepair
functional,orsemanticrelationshipsbetweenobjects. representsaconceptuallyundirectededge).Nodesforwallsonoppo-
sitesidesoftheroomarealsoconnectedtofurtherencodetheroom
4.2 GraphRepresentation shapeinthegraphstructure.Wallnodesalsostorethelengthofthe
wallsegment,andwall→walledgescarryanadditionalattribute
Weencoderelationshipsbetweenobjectsintheformofadirected
fortheanglebetweenthetwoadjacentwalls.Doorsandwindows
relationgraph.Inthisgraph,eachnodedenotesanobject,andeach
arerepresentedasnodesadjacenttotheirrespectivewall(s).Wedo
edgeencodesadirectedspatialorfunctionalrelationshipfromone
notincludeafloornodebecauseitaddsnomeaningfulinformation
objecttoanother.Eachnodeislabeledwithanobjectcategory(e.g.
(anyobjectwithoutasupportingnodeisonthefloor)anditover-
wardrobe)andafunctionalsymmetrytype.Functionalsymmetry
connectsthegraph(everyfloor-supportedobjectisjusttwohops
referstoanobjecthavingmultiplesemantically-meaningful“front”
awayfromeverywall).
directions,e.g.anL-shapedsectionalsofahastwopotential“front”
directions,regardlessofwhetherthesofahasaprecisegeometric
4.3 GraphExtraction
symmetry).Thisdeterminestheconfigurationsinwhichtheobject
canbeplacedwhilestillservingthesamefunction.Figure3shows Toconvertasceneintotheabovegraphrepresentation,weuse
examplesofthesymmetrytypeswecaptureinourgraphs. geometricheuristicstoextractasupersetofpossiblerelationships
thatmayexistbetweenobjects.Wethenuseadditionalgeometric
RelationshipEdges: Edgesintherelationgraphcaptureimportant andstatisticalheuristicstorefinethissettoreflectonlythemost
constraintsbetweenobjects:thattwoobjectsmustberelatedin meaningfulrelationships.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:7
Wall Wall Wall Wall !, Wall Wall
Summarize Add Node *?
=bed
Attribute
{+
les
= ft-r hig uh bt },
InitNode !#
Bed ! #
Add Edge?
{fro 'n$ t →-% p= r )o }ximal, Bed
Wall Wall !" Wall Wall
Edge Type + Direction (or STOP)
Wall Wall
Node Category (or STOP) Symmetry + Superstructure
Fig.7. Overviewofthegraphgenerationpipeline.Westartfromnodesandedgesdescribingthearchitectureoftheroomanditerativelyaddnewnodesand
edgeswithasequenceofdecisionmodulesthatpredictsthecategoryofthenewnode,thesymmetryandsuperstructuretypeofthenewnode,andtheedges
incidenttothenewlyaddednodes.
Table2. Informationourmodelconsumesand/orpredictsfordifferenttypes
2.Aggregatemessages:Toactuallypropagate
ofnodesandedgesinthegraph.
thecomputedmessages,theyaregatheredatthe
nodesincidenttotheirassociatededges.Sincea 𝒎 𝑢𝑣1
nodecanhavevaryingdegree,anoperationis + ObjectType IncludedFeatures
neededtomapthemessagestoanaggregated 𝒎 𝑢𝑣3 𝒎 𝑢𝑣2
messageh u′ withafixeddimension.Thisisoften 𝒉 𝑢′ Archite Oc btu jer ca tlx xu u C Ca at te eg go or ry y, ,L Syen mg mth et( rw ya tl yls po en ,Sly u) perstructuretype
donebysummingupthemessages,thoughother Architecturalxuv Distance,Direction,Anglebetweenwalls
order-invariantn-aryoperationssuchasmeancanalsobeused. Otherxuv Distance,Direction,Support
Foradirectedgraph,onlytheendnodeoftheedgereceivesthe
message.Thus,itisoftendesirabletoalsohaveasecondfunction
f′ thatcomputesmessagesinthereversedirection. latentspace.Foredgefeaturesxuv,informationnotpresent(e.g.
msg
3.Updatenodestate:Finally,theaggregatedmessage anglebetweenwallsfornon-walledges)issetto0.
h u′ isusedtoupdatethelatentnoderepresentationhu. ! " ! "# StructureBuildingModules. Fig7showsourpipeline.Starting
Sincewewanttokeepthelatentrepresentationcon-
witharchitecturalnodesandedges,weuseseveraldecisionmodules
sistentacrossdifferentstepsinthegenerativemodel, GRU toiterativelybuildthegraph:
weuseaGatedRecurrentUnitastheupdatefunction.
1.AddNode?Ateachstep,wefirstpredictwhatnodetoadd.This
moduleperformsT roundsofpropagation,thenappliesaneural
Summarization. Inadditiontoaggregated
network f topredictadiscretedistributionoverthepossible
features at nodes, many tasks require an ! add
overalldescriptionhG oftheentiregraph. "$ o ab “j Se Tct Oc Pa "te cg ao tr ei ge os rf yro wm ht ih ce hg ir na dp ih car te ep sr te hse an tt na otio mn oh reG n.W ode ea sls so hoin uc ldlu bd ee
Such a description can be constructed by &
computingafeaturevectorforeachnode, ! "# ⨀ ! "% added.Thismoduleissimilartotheimage-basedcategoryprediction
module of prior work [Ritchie et al. 2019]. However, instead of
andsummingthesevectorsdirectly.Asdif-
& & trainingthemoduletoalwayspickcategoriesinthesameorder,
ferentnodescanbeardifferentimportance
⨀ ⨀ wefoundthatarandomorderingissufficientforthistask.Random
to the entire graph, a gated sum is often +
orderinghasthebenefitofsupportingpartialgraphcompletion
used,whereagatefunctionσ iscomputed
! startingfromanysetofnodes.
andmultipliedwitheachnodevectorbefore )
2.Attributes.Inadditiontothenode’scategory,wealsoneedto
summingup.
knowitssymmetrytype,andwhetheritbelongstoasuperstructure.
5.2 GenerativeModelofSceneRelationshipGraphs
Todoso,weapplyanotherneuralnetwork fsym topredictadis-
cretedistributionoverallpossiblecombinationsofsymmetryand
Ourapproachtogeneratingscenerelationshipgraphsusestheabove superstructuretypesfromthesamegraphrepresentationhG used
buildingblocks.Inparticular,welargelyfollowthedesignof[Li inthepreviousstep.Toconditiononthepredictedobjectcategory,
etal.2018b],whereaseriesofstructuraldecisionmodulesareused weuseseparatenetworkweightsforeachcategory.
toaddnewnodesandnewedgestothegraphinanautoregressive 3.AddEdge?Finally,weaddthenewnodetothegraphanddeter-
fashion,untilcompletion. minetheedgesincidenttoit.Weuseaneuralnetworkf which
edge
takesasinputnodefeatureshu,hv forthenewnodevandexisting
FeatureRepresentationandInitialization. Nodesandedgesinour nodeuandoutputslogprobabilitiesforaddingeachpossibletype
graphbelongtotwomajorcategories.Architecturalnodesandedges ofedgebetweenthosenodes.Wecomputetheselogprobabilities
definetheroomarchitecture.Wealwaysinitializeourgraphwith forallexistingnodesu,concatenatethemintoonedistribution,and
these, and never predict additional instances. Object nodes, and samplefromit.Unlikepriorwork[Lietal.2018b],wedonotbreak
edgesconnectedtothem,describetheroomlayoutwewanttopre- thisstepintotwomodules:ShouldAddEdge? andWhichEdge?.
dict.Table2summarizestheinputfeaturesusedfordifferenttypes Instead,weappendtotheconcatenatedlogitsanadditionalfixed-
ofnodesandedges.Weuseseparatefinitfunctionsforarchitectural valuelogitindicating“STOP."Wedosobecausewefindthatthe
andobjectnodestomaptheirdifferentfeaturesetstothesame predictionsofthesetwomodulesareofteninconsistent:themodule
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:8 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
Section4,thegraphsfromwhichourgraphgenerativemodellearns
(andthusthegraphsthatitlearnstogenerate)arenotcomplete
scenespecifications:ingeneral,agraphdoesnotcontainenough
relationshipedgestouniquelydeterminethespatialpositionsand
orientationsofallobjectnodes.Rather,thereisasetofpossible
objectlayoutswhichareconsistentwiththegraph.Inotherwords,
thegraphdefinesasetofconstraints,andinstantiatingalayout
thatsatisfiesthemrequiressolvingaconstraintsatisfactionproblem
(CSP).Furthermore,notallsceneswithinthisfeasiblesetarecreated
equal;somewillappearmoreplausiblethanothers.Specifically,
somefeasiblesceneswillrespectcommonsenselayoutprinciples
thatdonotappearinthegraphbutneverthelessmustbefollowed
toensureplausibility.Thus,werequiresomekindofpriorover
scenestoplausiblyfillinthesegapsleftunspecifiedbythegraph.
Putanotherway,weseeknotanyfeasiblescene,butratherthemost
Fig.8. Scenerelationshipgraphsgeneratedbyourmodel. probablescenesfromwithinthefeasibleset.
Moreformally,werequireaprocedureforsamplingfromthe
followingconditionalprobabilitydistribution:
candecidetoaddanewedgebuthaveahighentropydistributionof
(cid:214) (cid:214)
possibleedgestoadd.Thisstepisiterateduntilthenetworkdecide p(S|G(V,E))=p(S)· 1(v∈S)· r(S,u,v) (1)
thatnomoreedgesshouldbeadded.Beforeeachiteration,anaddi- v∈V (u,v,r)∈E
tionalT roundsofpropagationisperformed.Wealsouseseparate
networkweightsforobject-architectureedgesandobject-object whereSisascene,G(V,E)isagraphwithverticesV andedgesE,
edges,sincethoseedgesbehavedifferently.Finally,attesttime,we andr(·)isapredicatefunctionindicatingwhethertherelationship
rejectsamplededgesthatneveroccurinthedataset,thoughthisis impliedbytheedge(u,v,r)issatisfiedinS.Theconditionalproba-
rare. bilityfactorsastheproductofthepriorprobabilityoverscenesp(S)
Implementation Details. We useT = 3 rounds of propagation
(whichisimpliedbythedataset)andaproductof{0,1}constraint
indicatorfunctions.Withmultipleconstraints,muchofthework
everywhere,andweuseathreelayerMLPforallstructuraldecision
involvedinsamplingthisdistributionisinfindingasceneSwith
modules.WealsouseathreelayerMLPforfmsgduringpropagation,
nonzeroprobability.Forthis,weadoptabacktrackingsearchstrat-
insteadofthesinglelinearlayersuggestedby[Lietal.2018b],as
egy,asiscommonforCSPsolving:weinstantiateobjectsoneata
thisperformedsignificantlybetterinourexperiments.AllMLPs
timeuntilsomerelationshipconstraintisviolated,atwhichpoint
usedahiddenlayersizeof384.Foradditionalrobustness,weinclude
werollbackoneormorestepsandretry.Withinthisframework,
theone-hotnoderepresentationxu inadditiontothelatenthu as
wealsorequire(a)ameansofselectingvaluesforanobject’sspatial
inputwhencomputingmessages,andweincludethefullgraph
configurationvariables(position,orientation,size),and(b)awayto
representationhG whencomputingper-nodeedgedistributions.
evaluatep(S).Here,wekilltwobirdswithonestone:wegenerate
configurationvaluesvianeuralnetswhicharetrainedtosample
Figure8showssomegraphsgeneratedbythismodel.Theycapture
fromanapproximationoftheconditionalprobabilityinEquation1.
importanthigh-levelstructuralpatternsandaregenerallyspatially
Thismakesourinstantiationalgorithmaneurally-guidedsearch
consistent(thenextsectionevaluatesthismorethoroughly).Occa-
procedure[Ritchieetal.2016;Vijayakumaretal.2018].
sionally,themodelgeneratesinconsistentresults.Werejectobvious
Therestofthissectionexplainsthedesigndecisionsbehindour
failurescaseswherethegraphisdisconnected,acyclic,orcontains
searchprocedure:theorderinwhichtoinstantiate,theneuralnets
inconsistentchains.Wealsoaddresssomeofthemoresubtlespatial
usedtosampleobjectconfigurations,andourbacktrackingstrategy.
inconsistenciesintheinstantiationprocess,discussedinthefollow-
ingsection.Still,mostoftheseissuescouldbebetterresolvedby
6.1 ObjectInstantiationOrder
adoptingamoresophisticatedgraphgenerativemodel,instances
ofwhicharerapidlyemerging.Forexample,amodelwhichcou- TheorderinwhichaCSPsolverassignsvaluestovariableshas
plesallstructure-buildingdecisionsthroughagloballatentvariable significantimpactonitsperformance.Acommonorderingstrategy
couldincreaseglobalcoherence[Jinetal.2018].Onecouldalsouse istheMostConstrainedVariable(MCV)heuristic:assignvalues
reinforcementlearningtoforcethemodel’soutputtobespatially tovariablesthatparticipateinthemostconstraintsfirst[Russell
realizable[Youetal.2018a]. andNorvig2009].Theintuitionhereisthatsuchassignmentswill
causethesearchto“failfast,”allowingittocorrectaninfeasible
6 SCENEINSTANTIATION
assignmenttooneormoreofthosevariableswithoutrequiring
Inthissection,wedescribeourprocedurefortakingarelationship significantbacktracking.
graph(eithergeneratedormanually-authored)andinstantiating Ouralgorithmfordeterminingtheorderinwhichtoinstantiate
itintoanactual3Dscene.Duetotheedgepruningstepstakenin objectsfollowsasimilarlogic.Itusesthestructureofthegraph,
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:9
6.2 Neurally-GuidedObjectInstantiation
alongwithstatisticsabouttypicalsizesfornodesofdifferentcate-
gories,todetermineanorderingthatleadstofastfailureandmini- Oncewehaveselectedanobjectofcategoryctoaddtothescene,as
mizesbacktracking.Mostoftheseprinciplesarenotspecifictothe prescribedbytheorderingabove,wemustproposeaconfiguration
indoorscenedomainandwouldbevalidformanyconstraint-based forit:itslocationx,orientationθ,andphysicaldimensionsdxy.
spatiallayoutproblemswithconstraintsderivedfromagraph. Ideally,weseekageneratorfunctionд(x,θ,dxy|c,S,G(V,E))which
outputsvalueswithprobabilityproportionaltothetrueconditional
Orderingpreliminaries: Werequirethatourorderingalgorithm
sortsceneobjectstopologically:anobjectcannotbeinstantiated
sceneprobabilityp(Sˆ =S∪{(c,x,θ,dxy)}|G(V,E))inEquation1.
Inotherwords,weneedtodesignanimportancesamplerforp.
untilallitsinboundneighborswhichconstrainitsplacementhave
As in prior work on scene synthesis by iterative object inser-
alsobeeninstantiated.Amongthedifferentpossibletopological
tion[Ritchieetal.2019],wedecomposetheconfigurationgenerator
sorts,weadditionallyrequirethatoursfollowsadepth-firstordering:
whenanodeisaddedtothescene,allofitsdescendantsmustbe
asд(x,θ,dxy|·)=д(dxy|θ,x,·)д(θ|x,·)д(x|·)accordingtothechain
rule,i.e.wesamplelocation,thenorientation,thendimensions.
addedbeforeanyofitsnon-descendants.Thisrequirementleadsto
insertionordersthat“grow”inwardfromthewalls,whichismore Location. Sincep factorizes as the product of the scene prior
likelytoinstantiatecoherentsub-partsofthescenetogether(and probabilityp(S)andtheconstraintfunctions,onepossiblestrategy
whichweexploitduringbacktracking. istousealearnedprioroverobjectlocationsinscenesforд(x|·).For
ourprior,weadoptthelocationpredictionmodulefrom[Ritchie
Constraint-based ordering: For most graphs, there exist many
etal.2019],whichisastate-of-the-artimage-basedprioroverscenes.
possibleorderingsthatsatisfytheaboverequirements.Thus,we
Itisafully-convolutionalnetwork(FCN)thattakesasinputatop-
additionallysortnodes based onhowconstrained theyare.This
downviewofthesceneSandproducesanimage-spaceprobability
measureisbasedonthenumberofinboundedgestoanode,asan
distribution over possible locations for the next object to insert.
objectwithaspecifiedlocationrelativetomultipleotherobjectshas
Whilethisisagoodimportancesamplerforp(S),itisfarfromideal
fewerpossiblevalidplacements.Specifically,wedefinethescore
whenusedtosampletheconditionaldistributioninEquation1,as
C→(v)tobetheweightedsumofnodev’sinboundedges,where
manyproposedlocationswillviolatetheconstraints(Table3).
adjacent,proximal,anddistantedgesareweightedina3:2:1ratio.
Wewouldpreferourimportancesamplerд(x|·)torespectcon-
FornodeswiththesameC→score,webreaktiesbasedonwhich
straintsbyconstruction,ratherthanbyrejection.Todothis,we
nodewouldbemostconstrainingifitweretobeinstantiatednext.
modifytheFCNarchitectureof[Ritchieetal.2019]tobeawareof
WedefineasecondscoreC←(v)as:
therelationshipgraph.Figure9showsaschematicofthisarchi-
(cid:213) tecture.Ratherthanpredictingalocationdistributionforatarget
C←(v)= C→(u)·E[Size(u)]
objectintheabsolutecoordinateframeofasceneimage,itpredicts
u∈DG[v]
adistributioninalocal coordinateframerelativetooneofthat
object’sinboundneighborsinthegraph;wecalltheseneighbors
whereDG[v]arethe(inclusive)descendantsofvandtheexpected
anchors.Furthermore,theFCNtakesanadditionalinputintheform
valueofthesizeofanodeistheaverage2Dprojectedbounding
ofthetypeofrelationshipedgebetweentheanchorandthetarget
boxareaofobjectsofthatnode’scategoryinthedataset.Inother
(e.g.left,adjacent),turningitintoaconditionalFCN(CFCN).This
words,anodeisveryconstrainingifinstantiatingitwouldleadto
additionalinputisinjectedintothenetworkviaFeaturewiseLinear
theinsertionofmanylargeobjectswhicharethemselveshighly
Modulation(FiLM),aprocessthatappliesalearnedscaleandshift
constrained(i.e.haverelativelyfixedpositions).
totheoutputofeveryconvolutionallayer[Perezetal.2018].If
Domain-specificorderingprinciples: Weuseafeworderingprinci- thereismorethanoneanchorobject,themodulepredictsarelative
pleswhicharespecifictoindoorscenes.First,weimposeadditional locationdistributionforeachofthem,transformstheseintothe
requirementsontheobjectinsertionorderingtopreservethein- globalcoordinateframe,andcombinesthemviamultiplicationand
tegrityofsuperstructures.Whenahubnodeisaddedtotheorder, renormalization(Figure10).Thislocallocationpredictionstrategy
weadditsspokenodesbeforeanyotheroutboundneighbors.When canbeseenasaformofvisualattention[Xuetal.2015],supervised
achainstartnodeisadded,weaddallthenodesinthechain,fol- bythestructureofthegraph.Conditioningthenetworktobegraph-
lowedbytheunionoftheirdescendants.Inaddition,weplaceall awareinthiswaysignificantlyreducesthepercentageofproposed
second-tier(i.e.supported)objectsafterallfirst-tierobjects. locationswhichviolateconstraints(Table3,Figure11).
Wecreatetrainingdataforthisnetworkbyrandomlyremoving
. Wenotethatpriorscenesynthesismethodswhichiteratively asubsetofobjectsfromascene,choosinganobjectwithatleast
constructscenesobject-by-objecthavealsohadtocontendwiththe oneoutgoingedgetooneoftheremovedobjectsastheanchor,
object-orderingproblem.Atleastonepriorworkhasusedarandom andtaskingitwithpredictingthelocationofthatobject.Wealso
orderingofobjects[Wangetal.2018].Anotherpossibilityistouse performdataaugmentationbyexploitingthesymmetrytypeofthe
anad-hoc“importance”order,i.e.orderingobjectsbyacombination anchorobject.Forexample,iftheanchorhasaleft/rightreflectional
oftheirsizeandfrequencyinthedataset[Ritchieetal.2019].The symmetry,werandomlychoosewhethertoreflecttheinputimage
latterstrategycanbeseenasaformofMostConstrain(ing)Variable acrosstheanchor’ssymmetryplane.Moregenerally,asymmetry
heuristic.Ourgraph-basedrepresentationprovidesarichersetof typeimpliestheobjecthassomenumberofequivalentcoordinate
informationfromwhichtoderiveamoresophisticatedordering. frames,andwepickoneofthematrandomduringtraining.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:11
Table3. Evaluatingtheperformanceofdifferentlocationsamplingmethods
(Top)anddifferentgraphgeneration/instantiationstrategies(Bottom)in
termsoftheaveragenumberofuninstantiablegraphs(Rejections),theaver-
agenumberofbacktrackingstepsinitiatedperobjectinsertion(Backtracks),
theaveragenumberofgraphconstraintsviolatedinthefinaloutputscene
(Violations),andtheaveragetimetakeninsecondstoinstantiateascene
(Time).
Method Rejections Backtracks Violations Time
RandomLocationSample 0.283 13.017 0.739 45.167
FCN-basedLocationsample 0.050 9.317 0.453 19.367
CFCN+AllHeuristics 0.067 3.767 0.057 10.783
NoPruning 0.067 19.067 1.704 46.429
HalfPruning 0.083 10.283 0.475 20.889
NoConstraintBasedOrdering 0.117 6.133 0.153 17.505
Fig.12. Agraphdoesnotuniquelydescribeascene;hereweshowmultiple
instantiationsofthesamegraph.
. Table3showssomestatisticsforourbacktrackingsearchproce-
dureonbedrooms.Wereportthefrequencyofrejectedinsertions,
backtrackingsteps,andconstraintviolationsinfinalgraphs.Topro-
videbaselines,weperformanablationstudyinwhichweusesearch
withnoneuralguidance(i.e.randomsamplingofobjectconfigu-
rations),thenon-conditionalFCNwhichisoblivioustothegraph,
andusingouredge-conditionalCFCN.Performanceonallmetrics
improveswithmorespecificneuralguidance.Similarly,ouredge
pruningandconstraint-basedorderingheuristicshavesignificant
impactonbacktrackingperformance.Removingthem,orusinga
pruningthresholdthatishalfasstrict,leadstoworseperformance.
7 RESULTS&EVALUATION
Inthissection,wepresentqualitativeandquantitativeresultsdemon-
Fig.13. Completedscenesfromapartialgraphmanuallyconstructedfrom
stratingtheutilityofthePlanITapproachtoscenesynthesisand
anaturallanguagedescription.Top:twosinglebedsbythebottomwall,
comparingittopriorscenesynthesismethods.
withafloorlampinbetween;Bottom:Anofficewithadesknearawalland
Synthesizingnewscenes: Figure1showsscenessynthesizedby someplants.Ourmodelisabletosynthesizeavarietyofscenesthatadhere
PlanIT,alongwiththeircorrespondinggraphs.Thegraphrepresen- tothedescription.
tationcontainsinformationthatallowstheinstantiationphasetore-
alizeotherwisechallenginglayouts,suchasthechainsofwardrobes
andkitchencabinets,ortheofficechairstuckedbetweendesksand withtwosinglebedsandanightstandbetweenthem”).Figure13
walls.AsmentionedearlierinSection6,arelationshipgraphusu- shows some examples of synthesis by partial graph completion.
allydoesnotuniquelyspecifyascene.Toillustratethisvisually, Thisissimilartopartialscenecompletion,buttheinputneednot
Figure12showsexamplesofinstantiatingthesamegraphmultiple specifythegeometryoreventheplacementoftheinitialobjects.
times. Wealsoevaluatethegeneralizationbehaviorofourmodel Priorobject-centricscenesynthesismethodseitherdonotsupport
bycomputingtheaveragesimilarityofageneratedscenetoitsmost partialstructurecompletion[Lietal.2018a]ormustinvokeamore
similarsceneinthetrainingset[Ritchieetal.2019].Theaverage expensiveoptimizationprocesstodoso[Zhangetal.2018].
similarityis0.781±0.049.Forreference,theaveragesimilarityof
PerceptualStudy: Asourfirstquantitativeevaluationofscenes
atrainingsetscenetothemostsimilarothersceneinthetraining
generatedbyPlanIT,weconductedatwo-alternativeforcedchoice
setis0.804±0.061).Thisindicatesthatourmodeldoesnotsimply
(2AFC)perceptualstudyonAmazonMechanicalTurkcomparingim-
memorize,andthatitgeneratessceneswithatleastasmuchinternal
agesofitsscenestothosegeneratedbyothermethods.Participants
diversityasthetrainingscenes.
wereshowntwotop-downsceneimagessidebysideandasked
Partialgraphcompletion: Becauseitinstantiatesscenesobject-by- topickthemoreplausibleone.Theseimageswererenderedusing
object,PlanITsupportscompletionofpartialscenes,asdoesprior solidcolorsforeachobjectcategory,tofactorouteffectsofmaterial
work[Ritchieetal.2019].OneuniquepropertyofPlanIT,however, appearance.Foreachcomparisonandeachroomtype,werecruited
isthatitalsosupportssynthesisfromapartialgraph.Theabilityto 10participants.Eachparticipantperformed55comparisons;5of
synthesizeascenefromahigh-levelpartialspecificationofwhatit thesewere“vigilancetests”comparingagainstarandomlyjumbled
shouldcontaincanbeuseful,forexampleindialogue-basedinter- scene(i.e.therandomsceneshouldalwaysbedis-preferred).We
faces(e.g.whendesigningabedroomfortwins:“showmebedrooms filteredoutparticipantswhodidnotpassallvigilancetests.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:12 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
Table4. Percentage(±standarderror)offorced-choicecomparisonsin
whichscenesgeneratedbyourmethodarejudgedasmoreplausiblethan
⇒
scenesfromanothersource.Higherisbetter.Boldindicateourscenesare
preferredwith>95%confidence;grayindicatesourscenesaredis-preferred
with> 95%confidence;regulartextindicatesnopreference.—indicates ⇓
unavailableresults.
⇐
Oursvs.
RoomType GRAINS Fast&Flexible SUNCG
Fig.14. Ourapproachcanbeusedtogeneratespecific,task-relevantscenes
Bedroom 59.3±4.3 48.2±4.4 44.1±4.8
forusein3Dsimulation.Inthisexample,wegenerateabedroomwitha
Living 82.9±3.4 45.9±6.6 44.9±5.2
nightstandandlamp.ThenweusetheMINOS[Savvaetal.2017]simulator
Office 76.3±5.6 57.4±5.1 41.3±6.6
toextractframesforcolor,depthandsemanticsegmentationduringa
Bathroom — 42.8±4.4 34.0±4.0
navigationtrajectorywherethegoalistolocatethelamponthenightstand
Kitchen — 51.2±5.1 29.9±4.2
(sequenceisclockwisefromtoplefttobottomleft).
Table5. Realvs.syntheticclassificationaccuracyforscenesgeneratedby
differentmethods.Lower(closerto50%)isbetter.Adaptedfrom[Ritchie
etal.2019],Table2. Timing: Wetrainandevaluateourmodelona12-coreInteli7-
6850Kmachinewith32GBRAMandanNVIDIAGTX1080TiGPU.
ThegraphgenerativemodelistrainedontheCPU;thistakes15
Method Accuracy
hoursforbedrooms,kitchensandtoilets,and10hoursforliving
DeepPriors[2018] 84.69 roomsandoffices.TheothermodulesaretrainedontheGPU,fol-
Fast&Flexible[2019] 58.75 lowingsuggestionsby[Ritchieetal.2019].
Ours 63.13 Attesttime,ittakes≈ 0.2secondstosampleagraph.Ittakes
onaverage10secondstoinstantiateagraph,withgraphsrequir-
ingminimalbacktrackingtaking≈1.5sandgraphswithrepeated
Table4showstheresultsofthisexperiment.PlanITconsistently
backtrackingtakingupto1minute.
outperformsGRAINS,thepreviousstate-of-the-artobject-centric
scene synthesis system. When compared to the Fast & Flexible GeneratingCustomVirtualAgentTrainingEnvironments: Partial
image-basedmethod,PlanITiscomparableacrossmostscenes(i.e. graphscanbeusedtospecifyobjectsthatmustbepresentinascene,
differencesarenotstatisticallysignificant).Withtheexceptionof thusallowingustogeneratecustomscenesthatcanbeusefulwhen
livingrooms,PlanIT’soutputscenesdonotfareaswellwhencom- specific tasks need to be performed in 3D simulation. Figure 14
paredtoscenescreatedbypeople.Theseresultssuggestthatthe showsanexample.
PlanITcandelivercomparableoutputqualitytootherstate-of-the-
art methods, while also supporting new applications and usage 8 CONCLUSION
modes.However,theconstraintsatisfactionproblemsimposedby
Inthispaper,wepresentedPlanIT,anewconceptualframeworkfor
generatedrelationshipgraphsarestilldifficulttosolve,andthus
layoutgenerationwhichdecomposestheproblemintotwostages:
PlanITisnotyetatthelevelofhuman-likescenedesigncapabilities.
planningandinstantiation.Wedemonstratedaconcreteimplemen-
Realvs.SyntheticClassificationExperiment: Inadditiontoasking tationofthePlanITframeworkforthedomainofindoorscenesyn-
peoplefortheirpreferences,wealsoaskmachines:wetrainaclas- thesis. Ourmethodplansascenebygeneratinganobjectrelation
sifiertodistinguishbetween“real”scenes(fromthetrainingset) graph,andthenitinstantiatesthatscenebysamplingcompatible
and“synthetic”scenes(generatedbyalearnedmodel).Weadopt objectconfigurations.Toprovidetrainingdataforoursystem,we
thesameexperimentsettingsaspriorwork[Ritchieetal.2019]:we describedaheuristicapproachforextractingrelationshipgraphs
useaResnet34thattakesasinputthesametop-downscenerep- fromunstructuredscenes.Wethendescribedagenerativemodelfor
resentationusedbythelocationsuggestionFCNfromSection6.2, suchgraphs,basedondeepgraphconvolutionalnetworks.Finally,
andrenderallscenesintothesamerepresentationbeforefeeding weshowedhowtoinstantiatearelationshipgraphbysearching
themtotheclassifier.Theclassifieristrainedwith1600scenes,half forobjectconfigurationsthatsatisfythegraph’sconstraints,using
fromthetrainingsetandhalfgenerated.Weevaluateaccuracyon image-basedconvolutionalnetworks.PlanIT’stwo-stagesynthesis
320heldouttestscenes. approach leads to more modeling flexibility and applicability to
Table5showstheresultsofthisexperiment.Ourmethodper- moreusecases,andourexperimentalresultsshowthatthisadding
formssimilarlytothepreviousimagebasedmethods.Itisnotsur- flexibilitydoesnotcomeatthecostofdecreasedoutputquality.
prisingPlanITisnotinfirstplaceonthismetric.Afterall,thegraphs Ourmethodisnotwithoutitslimitations. Figure15showssome
itgeneratesarebasedontraininggraphswhichprunedoutmany failurecasesofourmodel.Thesearisefromtheinstantiationmodule
edges.Essentially,wehavediscardedsomenoisewhichisinthe notmodelingthefunctionalityofobjectsandspaces(left)andmak-
data,andtheclassifierislikelypickinguponthefactthatthisnoise ingplacementerrorsthatdeviatefromastrictexpectedarrangement
ismissing. template(right).Thesecouldbeaddressedbyadding“emptyspace”
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:13
graph-basedintermediaterepresentation[Maetal.2018a].However,
itconstructsscenesbyretrievingpartsofscenesfromadatabase;
newpossibilitiesareopenedupbyasystemthatcansynthesize
trulynewscenesfromapartialgraph.
Lastbutnotleast,itisimportanttoexploretheapplicabilityofthe
PlanITframeworktootherlayoutgenerationapplications.Layoutis
acriticalsubprobleminmanygraphicsanddesigndomains.Could
Fig.15. Typicalfailurecasesforourmodel.Fromlefttoright:TVstand
onebuildagraph-basedplan-and-instantiateframeworkforpro-
blocksaccesstopartoftheroom;thisparticulardeskcannotbeaccessed
ducingconstrainedwebdesigns,orothertypesofgraphicdesigns?
whenusedinacorner;loudspeakersplacedbehindTVstandinsteadof
Thehybridnatureofourframeworkcouldbeveryuseful:thegraph
besideit;failuretopreciselyarrangediningchairsaroundthetable.
coulddictatethefunctionallayoutofdesignelements,whilethe
image-basedpriorscouldfocusonaestheticconcerns.
asafirst-classentityinthemodelandbyrefiningourtreatmentof ACKNOWLEDGMENTS
superstructurestoguaranteemoreprecisearrangements.
Wethanktheanonymousreviewersfortheirhelpfulsuggestions.
Ourresultsalsodependcriticallyonthequalityofthetraining
ScenerenderingsshowninthispaperwerecreatedusingtheMit-
graphsextractedfromtheinputscenedataset.Ourprocessforde-
subaphysically-basedrenderer[Jakob2010].Thisworkwassup-
terminingwhichedgestoincludeinthegraphsisheuristic.While
portedinpartbyNSFaward#1753684,ahardwaredonationfrom
webelieveourdesignchoicesarejustified,ourgraphextraction
Nvidia,andwiththesupportoftheTechnicalUniversityofMunich-
stepcouldverywellfilteroutimportantrelationshipsorinclude
InstituteforAdvancedStudy,fundedbytheGermanExcellence
spuriousones.Whatarethemostsalientrelationshipsinascene?
InitiativeandtheEuropeanUnionSeventhFrameworkProgramme
Thisquestionhasdifferentanswers,dependingonone’sinterpre-
undergrantagreementno291763.
tation.Dowecareaboutwhatismostsalienttoamachinetrying
toinstantiatethegraph?Orwhatismostsalienttoapersontrying REFERENCES
tospecifyasceneviaagraph?Isitpossibletolearnhowtoextract
PeterAnderson,BasuraFernando,MarkJohnson,andStephenGould.2016.Spice:Se-
goodrelationshipgraphs,perhapsbyusingreinforcementlearning
manticpropositionalimagecaptionevaluation.InEuropeanConferenceonComputer
toextractgraphswhichleadtographgenerativemodelswithhigh Vision(ECCV).Springer,382–398.
performanceonsomemetric?Furtherresearchisneededhere. MartinBokeloh,MichaelWand,andHanspeterSeidel.2010.Aconnectionbetween
partialsymmetryandinverseproceduralmodeling.InSIGGRAPH2010.
Ourgraphrepresentationitselfisalsolimitedbythesmallsetof AngelChang,WillMonroe,ManolisSavva,ChristopherPotts,andChristopherD.
relationshipsitencodes.Supportrelationshipsandfrequentspatial Manning.2015.Textto3DSceneGenerationwithRichLexicalGrounding.InACL
2015.
relationshipsonlyscratchthesurfaceofwhatispossibleinterms
AngelXChang,ManolisSavva,andChristopherDManning.2014. LearningSpa-
ofanalyzingthefunctionalityof3Dobjectsandscenes[Huetal. tialKnowledgeforTextto3DSceneGeneration.InEmpiricalMethodsinNatural
2018].Fortunately,asourgraphgenerativemodelarchitectureis LanguageProcessing(EMNLP).
ChaosGroup.2018. PuttingtheCGIinIKEA:HowV-RayHelpsVisualizePer-
quitegeneral,ourrelationshipgraphformatisquiteextensible.It
fectHomes.https://www.chaosgroup.com/blog/putting-the-cgi-in-ikea-how-v-ray-
wouldbeinterestingtoexploreaugmentingitwithmorenuanced helps-visualize-perfect-homes. Accessed:2018-10-13.
functionalrelationships(e.g.containment,affordancesforhuman KangChen,YukunLai,Yu-XinWu,RalphRobertMartin,andShi-MinHu.2014.Au-
tomaticsemanticmodelingofindoorscenesfromlow-qualityRGB-Ddatausing
activity)tohelpconstrainscenesynthesistowardproducingmore contextualinformation.ACMTransactionsonGraphics33,6(2014).
usableandinteractiveinteriorspaces. AngelaDai,DanielRitchie,MartinBokeloh,ScottReed,JürgenSturm,andMatthias
Nießner.2018. ScanComplete:Large-ScaleSceneCompletionandSemanticSeg-
Dividingthescenesynthesisproblemintotwophases,withan
mentationfor3DScans.InProc.ComputerVisionandPatternRecognition(CVPR),
intermediategraphrepresentation,makesPlanITflexibleandappli- IEEE.
cabletomoreusecases.Butitalsoturnssceneinstantiationinto AbhishekDas,SamyakDatta,GeorgiaGkioxari,StefanLee,DeviParikh,andDhruv
Batra.2018.EmbodiedQuestionAnswering.InCVPR.
aconstraintsatisfactionproblem,whichtakestimetosolve.Ifwe
P.ErdosandARenyi.1960.OntheEvolutionofRandomGraphs.InPUBLICATIONOF
giveuptheabilitytosynthesizescenesfromcompleteorpartial THEMATHEMATICALINSTITUTEOFTHEHUNGARIANACADEMYOFSCIENCES.
graphs,andinsteadfocusonsynthesizingscenesfromscratch,could 17–61.
MatthewFisher,DanielRitchie,ManolisSavva,ThomasFunkhouser,andPatHanrahan.
wecombinethegraphgenerationandsceneinstantiationphases? 2012. Example-basedSynthesisof3DObjectArrangements.InSIGGRAPHAsia
Thatis,couldonedesignatightly-integratedgenerativemodelthat 2012.
MatthewFisher,ManolisSavva,YangyanLi,PatHanrahan,andMatthiasNießner.2015.
generatesagraphwhileinstantiatingascenefromitinlock-step,
Activity-centricSceneSynthesisforFunctional3DSceneModeling.(2015).
whereeachrepresentationprovidesfeedbacktotheother?This QiangFu,XiaowuChen,XiaotianWang,SijiaWen,BinZhou,andHongboFu.2017.
seemslikeafruitfuldirectionforfuturework. AdaptiveSynthesisofIndoorScenesviaActivity-associatedObjectRelationGraphs.
InSIGGRAPHAsia2017.
Therearealsomanyopportunitiestoextendandapplyasystem
JustinGilmer,SamuelS.Schoenholz,PatrickF.Riley,OriolVinyals,andGeorgeE.Dahl.
likePlanIT.Forexample,itwouldbevaluabletodevelopanatural 2017. NeuralMessagePassingforQuantumChemistry. CoRRarXiv:1704.01212
languageinterfaceforconstructingpartialinputgraphs,asalluded (2017).
DanielGordon,AniruddhaKembhavi,MohammadRastegari,JosephRedmon,Dieter
toearlier.Whattypeoflanguagemustsuchasystemsupportto Fox,andAliFarhadi.2018.IQA:VisualQuestionAnsweringinInteractiveEnviron-
beuseful?Whatgraphrepresentationmapsmostnaturallytothis ments.InCVPR.
R.Hu,M.Savva,andO.vanKaick.2018.FunctionalityRepresentationsandApplications
language? There exists prior work in language-based scene cre-
forShapeAnalysis.ComputerGraphicsForum37,2(2018),603–624.
ation[Changetal.2015,2014],includingrecentworkthatusesa WenzelJakob.2010.Mitsubarenderer. http://www.mitsuba-renderer.org.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
132:14 • KaiWang,Yu-anLin,BenWeissmann,ManolisSavva,AngelX.Chang,andDanielRitchie
WengongJin,ReginaBarzilay,andTommiS.Jaakkola.2018.JunctionTreeVariational DanfeiXu,YukeZhu,ChristopherBChoy,andLiFei-Fei.2017.Scenegraphgeneration
AutoencoderforMolecularGraphGeneration.InICML2018. byiterativemessagepassing.InProceedingsoftheIEEEConferenceonComputer
JustinJohnson,AgrimGupta,andLiFei-Fei.2018.Imagegenerationfromscenegraphs. VisionandPatternRecognition,Vol.2.
InProceedingsoftheIEEEconferenceoncomputervisionandpatternrecognition KelvinXu,JimmyBa,RyanKiros,KyunghyunCho,AaronC.Courville,RuslanSalakhut-
(CVPR). dinov,RichardS.Zemel,andYoshuaBengio.2015.Show,AttendandTell:Neural
JustinJohnson,RanjayKrishna,MichaelStark,Li-JiaLi,DavidShamma,Michael ImageCaptionGenerationwithVisualAttention.CoRRarXiv:1502.03044(2015).
Bernstein,andLiFei-Fei.2015.Imageretrievalusingscenegraphs.InProceedingsof KunXu,KangChen,HongboFu,Wei-LunSun,andShi-MinHu.2013.Sketch2Scene:
theIEEEconferenceoncomputervisionandpatternrecognition(CVPR). Sketch-basedCo-retrievalandCo-placementof3DModels.InSIGGRAPH2013.
Z.SadeghipourKermani,Z.Liao,P.Tan,andH.Zhang.2016. Learning3DScene KenXu,JamesStewart,andEugeneFiume.2002.Constraint-basedautomaticplacement
SynthesisfromAnnotatedRGB-DImages.InEurographicsSymposiumonGeometry forscenecomposition.InGraphicsInterface,Vol.2.25–34.
Processing. SijieYan,YuanjunXiong,andDahuaLin.2018.SpatialTemporalGraphConvolutional
ThomasNKipfandMaxWelling.2016. Semi-supervisedclassificationwithgraph NetworksforSkeleton-BasedActionRecognition.InAAAI.
convolutionalnetworks.CoRRabs/1609.02907(2016). JianweiYang,JiasenLu,StefanLee,DhruvBatra,andDeviParikh.2018.Graphr-cnn
RanjayKrishna,YukeZhu,OliverGroth,JustinJohnson,KenjiHata,JoshuaKravitz, forscenegraphgeneration.InProceedingsoftheEuropeanConferenceonComputer
StephanieChen,YannisKalantidis,Li-JiaLi,DavidAShamma,etal.2017. Vi- Vision(ECCV).670–685.
sualgenome:Connectinglanguageandvisionusingcrowdsourceddenseimage JiaxuanYou,BowenLiu,RexYing,VijayS.Pande,andJureLeskovec.2018a.Graph
annotations.InternationalJournalofComputerVision123,1(2017),32–73. ConvolutionalPolicyNetworkforGoal-DirectedMolecularGraphGeneration.In
DannyLange.2018.UnityandDeepMindpartnertoadvanceAIresearch.https://blogs. NeurIPS2018.
unity3d.com/2018/09/26/unity-and-deepmind-partner-to-advance-ai-research. Ac- JiaxuanYou,RexYing,XiangRen,WilliamL.Hamilton,andJureLeskovec.2018b.
cessed:2018-10-13. GraphRNN:ADeepGenerativeModelforGraphs.InICML2018.
ManyiLi,AkshayGadiPatil,KaiXu,SiddharthaChaudhuri,OwaisKhan,ArielShamir, Lap-FaiYu,Sai-KitYeung,Chi-KeungTang,DemetriTerzopoulos,TonyF.Chan,and
ChangheTu,BaoquanChen,DanielCohen-Or,andHaoZhang.2018a.GRAINS: StanleyJ.Osher.2011. MakeItHome:AutomaticOptimizationofFurnitureAr-
GenerativeRecursiveAutoencodersforINdoorScenes. CoRRarXiv:1807.09193 rangement.InSIGGRAPH2011.
(2018). RowanZellers,MarkYatskar,SamThomson,andYejinChoi.2018. NeuralMotifs:
YikangLi,WanliOuyang,BoleiZhou,KunWang,andXiaogangWang.2017.Scene SceneGraphParsingwithGlobalContext.InProceedingsoftheIEEEConferenceon
graphgenerationfromobjects,phrasesandregioncaptions.InICCV. ComputerVisionandPatternRecognition.5831–5840.
YujiaLi,OriolVinyals,ChrisDyer,RazvanPascanu,andPeterBattaglia.2018b.Learning ZaiweiZhang,ZhenpeiYang,ChongyangMa,LinjieLuo,AlexanderHuth,Etienne
deepgenerativemodelsofgraphs.CoRRabs/1803.03324(2018). Vouga,andQixingHuang.2018.DeepGenerativeModelingforSceneSynthesisvia
TianqiangLiu,SiddharthaChaudhuri,VladimirG.Kim,Qi-XingHuang,NiloyJ.Mi- HybridRepresentations.CoRRarXiv:1808.02084(2018).
tra,andThomasFunkhouser.2014. CreatingConsistentSceneGraphsUsinga
ProbabilisticGrammar.InSIGGRAPHAsia2014. A GRAPHEXTRACTIONHEURISTICS
CewuLu,RanjayKrishna,MichaelBernstein,andLiFei-Fei.2016.Visualrelationship
detectionwithlanguagepriors.InEuropeanConferenceonComputerVision(ECCV).
This appendix provides more detail about the automatic heuris-
Springer,852–869.
RuiMa,AkshayGadiPatil,MatthewFisher,ManyiLi,SorenPirk,Binh-SonHua,Sai- ticsweuseforextractingrelationshipgraphsfrom3Dscenes.The
KitYeung,XinTong,LeonidasGuibas,andHaoZhang.2018a.Language-driven completesourcecodeforthisprocedureisalsoavailableonlineat
synthesisof3Dscenesfromscenedatabases.InSIGGRAPHAsia2018.
https://github.com/brownvc/planit.
RuiMa,AkshayGadiPatil,MattFisher,ManyiLi,SorenPirk,Binh-SonHua,Sai-Kit
Yeung,XinTong,LeonidasJ.Guibas,andHaoZhang.2018b. Language-Driven
Synthesisof3DScenesUsingSceneDatabases.ACMTransactionsonGraphics37,6 A.1 Detecting“Superstructures”
(2018).
PaulMerrell,EricSchkufza,ZeyangLi,ManeeshAgrawala,andVladlenKoltun.2011. Therulesfordetectingandextractingsuperstructuresare:
InteractiveFurnitureLayoutUsingInteriorDesignGuidelines.InSIGGRAPH2011.
VittorioFerrariPaulHenderson,KarticSubr.2018. AutomaticGenerationofCon- Hub-and-spokes: Wedetecthubsbysearchingforgraphnodes
strainedFurnitureLayouts.CoRRarXiv:1711.10939(2018). withmultipleoutboundedgestonodesrepresentingsmallerobjects
EthanPerez,FlorianStrub,HarmdeVries,VincentDumoulin,andAaronC.Courville.
2018.FiLM:VisualReasoningwithaGeneralConditioningLayer.InAAAI2018. ofthesamecategory.Suchanodeisahubifthearrangementofthose
Planner5d.2017.HomeDesignSoftwareandInteriorDesignToolONLINEforhome neighbornodes(spokes)isinvariantunderthenode’ssymmetry
andfloorplansin2Dand3D.https://planner5d.com. Accessed:2017-10-20.
group(e.g.aspoketotheleftandaspoketotheright,foranode
SiyuanQi,YixinZhu,SiyuanHuang,ChenfanfuJiang,andSong-ChunZhu.2018.
Human-centricIndoorSceneSynthesisUsingStochasticGrammar.InConferenceon withleft-rightreflectionalsymmetry).Thehubnodeinheritsall
ComputerVisionandPatternRecognition(CVPR). theinboundedgesofitsspokes.Thespokesinturndiscardany
DanielRitchie,AnnaThomas,PatHanrahan,andNoahD.Goodman.2016.Neurally-
inboundedgesexceptfortheedgefromthehubandanyadjacent
GuidedProceduralModels:AmortizedInferenceforProceduralGraphicsPrograms
usingNeuralNetworks.InNIPS2016. relationships.Thereasoninghereisthatthehubistheprimarycue
DanielRitchie,KaiWang,andYuanLin.2019.FastandFlexibleIndoorSceneSynthesis fortheplacementofthespokes;theonlyotherrelevantinformation
viaDeepConvolutionalGenerativeModels.InCVPR2019.
RoomSketcher.2017.VisualizingHomes.http://www.roomsketcher.com. Accessed: tomaintainiswhetherthespokesaredirectlyadjacenttoanyother
2017-11-06. objects.
GrzegorzRozenberg(Ed.).1997. HandbookofGraphGrammarsandComputingby
GraphTransformation:VolumeI.Foundations.WorldScientificPublishingCo.,Inc., Chain: Wedetecttwovariants of‘chain”structures. First, we
RiverEdge,NJ,USA.
StuartRussellandPeterNorvig.2009.ArtificialIntelligence:AModernApproach(3rd detectanysequenceofthreeormoreobjectnodesofasimilarsize
ed.).PrenticeHallPress,UpperSaddleRiver,NJ,USA. connectedbyadjacentedgesinthesamedirection.Thiscondition
ManolisSavva,AngelX.Chang,AlexeyDosovitskiy,ThomasFunkhouser,andVladlen
capturesfunctionalarrangementswherealargerstructureisassem-
Koltun.2017. MINOS:MultimodalIndoorSimulatorforNavigationinComplex
Environments.arXiv:1712.03931(2017). bledfrommultiplecontiguousparts(e.g.kitchencabinetry).We
ShuranSong,FisherYu,AndyZeng,AngelXChang,ManolisSavva,andThomas alsodetectanysequenceofthreeormoreinstancesofthesame
Funkhouser.2017.SemanticSceneCompletionfromaSingleDepthImage.CVPR
objectconnectedbyproximaledgesinthesamedirection.Thiscon-
2017.
AshwinJ.Vijayakumar,AbhishekMohta,OleksandrPolozov,DhruvBatra,Prateek ditioncapturescommonly-occurringstructureswithmoreaesthetic
Jain,andSumitGulwani.2018. Neural-GuidedDeductiveSearchforReal-Time purpose(e.g.arowofplants).Sincethespatialconfigurationofthe
ProgramSynthesisfromExamples.InICLR2018.
KaiWang,ManolisSavva,AngelX.Chang,andDanielRitchie.2018.DeepConvolu- chainiscompletelydeterminedbyitsstartandendnodes,chain
tionalPriorsforIndoorSceneSynthesis.InSIGGRAPH2018. intermediatenodesdiscardalloftheirinboundedgesandinherit
whateverinboundedgesarecommontoboththestartandendnode.
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.
PlanIT:PlanningandInstantiatingIndoorSceneswithRelationGraphandSpatialPriorNetworks • 132:15
A.2 EdgePruning
insertion(duetocollision,constraintviolation,ortoomuchover-
Therulesforpruningtheinitialsetofextractedgraphedgesare: hangforsecond-tierobjects)foranobject ≈10times,decreasingas
thenumberofsampleattemptsatthecurrentobjectincreases.We
Keptedges: Wealwaysretainsupportedges,wall→objectad- backtracktotheclosestobject,priorintheinsertionorderdescribed
jacent edges,andsuperstructureedges,asthesearecriticallyim- inSection6.1,thathasresultedinainsertionfailure.Toprevent
portant for determining object placement. In an effort to retain repeatedrejectionsduetothemodulerepeatedlyresamplingthe
edgesthatreflectlayoutintentionality,wealsoretainalladjacent samebadconfiguration,whenaninsertionpointisrejected,we
edgesbetweenobjectsofthesamecategory,aswellproximaledges zeroouttheprobabilityaroundthatpointintheCFCN-predicted
originatingfromanobjectwithauniquefrontdirection(i.e.not locationdistribution.Thisstartswith0.6m×0.6m,andgradually
symmetricorleft-rightreflectionallysymmetric).Theselatteredges increasesasnumberofbacktracksincreases.
correspondtoanobject“pointingat”somethingnearby(e.g.arm
Constraintrelaxation. Ourschemeforconstraintrelaxationisas
chairpointingatatelevision).
follows:wemaintainaconstraintviolationcostforeachobject(mea-
Deletededges: Wealwaysdeletewall→objectedgesthatarenot suringhowmuchitviolatesallofitsadjacentrelationshipedges),
adjacent,toreducetheoverwhelminglylargenumberofsuchedges whichiscomputedbasedonthesamegeometricpredicatesand
(44–59%ofall‘→object’edgesintheinitialgraphs,depending visibilitycomputationsthatwedescribedinSection4.Itstartswith
onroomtype).Therearealsomanyoccurrencesof‘doubleedges,’ 0withnoviolations,andcapsat1ifeithertheobjectiscompletely
i.e.boththeedgesA→BandA←Bexist.Webreakthesecycles invisible/occludedorifitismorethanacertaindistanceawayfrom
by choosing only one of the edges. If the categories ofAandB thedistancethreshold.Ifanodehasmorethanoneconstraint,ato-
aredifferent,weorienttheedgefromlargest-to-smallestobject. talscoreof1isdistributeduniformlytoeach.Weallownoviolation
Otherwise(ifthecategoriesarethesame),wepreferfront edges forthefirst1/4ofthemaximumallowedsteps,andallownodes
overbackandrightoverleft. tocarryahighercostasaquadraticallyincreasingfunctionofthe
numberofbacktrackingstepsthathavebeenperformed,capped
Data-drivenpruning: Deletingtheaboveedgesstillleavesthe at1.Bydoingso,wewillstartwithallowingsmallviolationsto
graphwithtoomanyrelationships.Toaddressthisissue,welook visibilityanddistance,followedbyallowingcompleteviolationof
tothestatisticsofourlargescenedataset:arelationshipA→Bis oneofmanyconstraints,etc.Weneverallowallconstraintstoa
significantifitoccursinasignificantpercentageofscenesinwhich nodetobecompletelyviolated(i.e.acostof1).Ifthathappens,the
objectsofcategoryAandBbothoccur.Otherwise,weprunethe instantiationprocessfails.
edge.Weuseseparate,increasingpercentagethresholdsforeach
distancelevel(3%foradjacent;8%forproximal;30%fordistant),
reflectingtheintuitionthate.g.adistantrelationshipmustoccur
much more commonly than an adjacent relationship before we
believethatitisintentional.
A.3 GuaranteeingConnectivity
Weguaranteethatextractedgraphsareconnectedbyfindingall
unreachablenodesandreconnectingthemtothegraphbysearching
intheoriginal,unprunedgraphfortheminimum-costpathfrom
anywalltothatnode.Todefinethecostofapath,wesaythatany
pathwhichinducesacycleinthegraphhasahighercostthanany
paththatdoesnot;otherwise,thecostofapathisthesumofits
edgecosts.Wepreferedgesthatarealreadyinourprunedgraph,
followedbyadjacentedgesandthenproximaledges(providedthey
flowfromlarger→smallerobjects),andfinallydistantedges(with
shorterdistancespreferred).Duetothiscycle-avoidancebehavior,
ourfinalextractedgraphsareacyclic(withtheexceptionofafew
kitchenscenes,whicharedensewithchainsandadjacentedges
betweene.g.contiguouscountersegments).
B BACKTRACKINGDETAILS
Thisappendixprovidesmoredetailaboutthebacktrackingsearch
procedureweusetoinstantiatescenes.Thecompletesourcecode
for this procedure is also available online at https://github.com/
brownvc/planit.
Ourbacktrackingpolicyistore-sampleapreviously-instantiated
objectwhenourobjectinsertionmodelsfailtofindasatisfying
ACMTrans.Graph.,Vol.38,No.4,Article132.Publicationdate:July2019.

